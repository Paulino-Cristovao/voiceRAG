<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico - Mozaitelecomunica√ß√£o</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 { color: #667eea; }
        .test {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #ddd;
        }
        .test.success { border-left-color: #22c55e; }
        .test.error { border-left-color: #ef4444; }
        .test.warning { border-left-color: #f59e0b; }
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: bold;
        }
        .status.ok { background: #dcfce7; color: #166534; }
        .status.fail { background: #fee2e2; color: #991b1b; }
        .status.warn { background: #fef3c7; color: #92400e; }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover { background: #5568d3; }
        pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
        }
        .info { color: #64748b; font-size: 14px; }
    </style>
</head>
<body>
    <h1>üîß Diagn√≥stico do Sistema</h1>
    <p class="info">Este teste verifica se seu navegador e sistema est√£o prontos para usar o assistente de voz.</p>

    <div id="results"></div>

    <button onclick="runTests()">‚ñ∂Ô∏è Executar Testes</button>
    <button onclick="testMicrophone()">üé§ Testar Microfone Agora</button>
    <button onclick="location.href='/'">üè† Voltar ao Assistente</button>

    <script>
        const results = document.getElementById('results');

        function addTest(name, status, message, details = '') {
            const statusClass = status === 'ok' ? 'success' : status === 'fail' ? 'error' : 'warning';
            const statusLabel = status === 'ok' ? 'OK' : status === 'fail' ? 'FALHOU' : 'AVISO';
            const statusColor = status === 'ok' ? 'ok' : status === 'fail' ? 'fail' : 'warn';

            const div = document.createElement('div');
            div.className = `test ${statusClass}`;
            div.innerHTML = `
                <strong>${name}</strong>
                <span class="status ${statusColor}">${statusLabel}</span>
                <div style="margin-top: 8px">${message}</div>
                ${details ? `<pre style="margin-top: 10px">${details}</pre>` : ''}
            `;
            results.appendChild(div);
        }

        async function runTests() {
            results.innerHTML = '<h2>Executando testes...</h2>';

            // Test 1: Browser Info
            const browser = navigator.userAgent;
            addTest(
                '1. Informa√ß√µes do Navegador',
                'ok',
                'Navegador detectado',
                browser
            );

            // Test 2: getUserMedia API
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                addTest(
                    '2. API getUserMedia',
                    'ok',
                    'API de captura de √°udio est√° dispon√≠vel'
                );
            } else {
                addTest(
                    '2. API getUserMedia',
                    'fail',
                    'API n√£o dispon√≠vel. Atualize seu navegador.',
                    'Navegadores suportados:\n‚Ä¢ Chrome 60+\n‚Ä¢ Firefox 55+\n‚Ä¢ Safari 14+\n‚Ä¢ Edge 79+'
                );
            }

            // Test 3: HTTPS/Localhost
            const protocol = window.location.protocol;
            const hostname = window.location.hostname;
            const isSecure = protocol === 'https:' || hostname === 'localhost' || hostname === '127.0.0.1';

            if (isSecure) {
                addTest(
                    '3. Conex√£o Segura',
                    'ok',
                    `Conex√£o via ${protocol} em ${hostname}`
                );
            } else {
                addTest(
                    '3. Conex√£o Segura',
                    'fail',
                    'Microfone requer HTTPS ou localhost',
                    `Acesse via:\n‚Ä¢ http://localhost:8000\n‚Ä¢ https://seu-dominio.com\n\nAtual: ${protocol}//${hostname}`
                );
            }

            // Test 4: MediaRecorder
            if (window.MediaRecorder) {
                addTest(
                    '4. MediaRecorder API',
                    'ok',
                    'API de grava√ß√£o dispon√≠vel'
                );
            } else {
                addTest(
                    '4. MediaRecorder API',
                    'fail',
                    'MediaRecorder n√£o dispon√≠vel'
                );
            }

            // Test 5: WebSocket
            if (window.WebSocket) {
                addTest(
                    '5. WebSocket',
                    'ok',
                    'WebSocket dispon√≠vel para comunica√ß√£o em tempo real'
                );
            } else {
                addTest(
                    '5. WebSocket',
                    'fail',
                    'WebSocket n√£o dispon√≠vel'
                );
            }

            // Test 6: Audio Playback
            const audio = new Audio();
            if (audio.canPlayType('audio/mpeg')) {
                addTest(
                    '6. Reprodu√ß√£o de √Åudio',
                    'ok',
                    'Navegador pode reproduzir √°udio MP3'
                );
            } else {
                addTest(
                    '6. Reprodu√ß√£o de √Åudio',
                    'warn',
                    'Formato MP3 pode n√£o ser suportado'
                );
            }

            // Test 7: Permissions
            if (navigator.permissions && navigator.permissions.query) {
                try {
                    const result = await navigator.permissions.query({ name: 'microphone' });
                    const state = result.state;

                    if (state === 'granted') {
                        addTest(
                            '7. Permiss√£o de Microfone',
                            'ok',
                            'Permiss√£o concedida ‚úÖ'
                        );
                    } else if (state === 'prompt') {
                        addTest(
                            '7. Permiss√£o de Microfone',
                            'warn',
                            'Permiss√£o ser√° solicitada ao usar',
                            'Clique em "Permitir" quando o navegador pedir'
                        );
                    } else {
                        addTest(
                            '7. Permiss√£o de Microfone',
                            'fail',
                            'Permiss√£o negada ‚ùå',
                            'Como permitir:\n‚Ä¢ Chrome: Clique no üîí ‚Üí Microfone ‚Üí Permitir\n‚Ä¢ Safari: Prefer√™ncias ‚Üí Sites ‚Üí Microfone ‚Üí Permitir\n‚Ä¢ Firefox: Clique no üîí ‚Üí Permiss√µes ‚Üí Permitir'
                        );
                    }
                } catch (e) {
                    addTest(
                        '7. Permiss√£o de Microfone',
                        'warn',
                        'N√£o foi poss√≠vel verificar permiss√µes',
                        'Ser√° solicitado ao usar o microfone'
                    );
                }
            } else {
                addTest(
                    '7. Permiss√£o de Microfone',
                    'warn',
                    'API de permiss√µes n√£o dispon√≠vel',
                    'Normal em alguns navegadores'
                );
            }

            // Summary
            const successCount = document.querySelectorAll('.test.success').length;
            const errorCount = document.querySelectorAll('.test.error').length;
            const warningCount = document.querySelectorAll('.test.warning').length;

            const summary = document.createElement('div');
            summary.style.marginTop = '20px';
            summary.style.padding = '20px';
            summary.style.background = errorCount > 0 ? '#fee2e2' : warningCount > 0 ? '#fef3c7' : '#dcfce7';
            summary.style.borderRadius = '8px';
            summary.innerHTML = `
                <h3>üìä Resumo</h3>
                <p>‚úÖ Sucesso: ${successCount} | ‚ö†Ô∏è Avisos: ${warningCount} | ‚ùå Erros: ${errorCount}</p>
                ${errorCount === 0 && warningCount === 0 ?
                    '<p><strong>‚úÖ Tudo pronto! Seu sistema est√° configurado corretamente.</strong></p>' :
                errorCount > 0 ?
                    '<p><strong>‚ùå H√° erros que precisam ser corrigidos antes de usar o sistema.</strong></p>' :
                    '<p><strong>‚ö†Ô∏è Sistema funcional, mas com avisos. Pode usar normalmente.</strong></p>'
                }
            `;
            results.appendChild(summary);
        }

        async function testMicrophone() {
            try {
                console.log('Solicitando acesso ao microfone...');
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

                addTest(
                    'üé§ Teste de Microfone',
                    'ok',
                    'Microfone acessado com sucesso! ‚úÖ',
                    'Fale algo e as barras de volume devem se mover.\nSe n√£o ouvir nada, verifique as configura√ß√µes de som.'
                );

                // Show audio level
                const audioContext = new AudioContext();
                const analyser = audioContext.createAnalyser();
                const microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);

                analyser.fftSize = 256;
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);

                let maxVolume = 0;
                const checkVolume = setInterval(() => {
                    analyser.getByteFrequencyData(dataArray);
                    const average = dataArray.reduce((a, b) => a + b) / bufferLength;
                    maxVolume = Math.max(maxVolume, average);
                    console.log('N√≠vel de √°udio:', Math.round(average));
                }, 100);

                // Stop after 5 seconds
                setTimeout(() => {
                    clearInterval(checkVolume);
                    stream.getTracks().forEach(track => track.stop());
                    audioContext.close();

                    if (maxVolume > 10) {
                        alert(`‚úÖ Microfone funcionando!\nN√≠vel m√°ximo detectado: ${Math.round(maxVolume)}`);
                    } else {
                        alert('‚ö†Ô∏è Microfone conectado, mas nenhum som detectado.\nVerifique se o microfone est√° ativo e fale mais alto.');
                    }
                }, 5000);

                alert('üé§ Teste iniciado! Fale algo nos pr√≥ximos 5 segundos...');

            } catch (error) {
                addTest(
                    'üé§ Teste de Microfone',
                    'fail',
                    `Erro: ${error.name}`,
                    `${error.message}\n\nSolu√ß√µes:\n‚Ä¢ Clique em "Permitir" quando o navegador pedir\n‚Ä¢ Verifique se um microfone est√° conectado\n‚Ä¢ Feche outros apps que usam o microfone`
                );
            }
        }

        // Run tests on load
        window.addEventListener('load', runTests);
    </script>
</body>
</html>
