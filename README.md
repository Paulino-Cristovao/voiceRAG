# 🎙️ Voice RAG - Assistente de Voz com IA

Sistema de atendimento ao cliente com voz usando RAG (Retrieval-Augmented Generation) com **LangChain**, permitindo conversas naturais sobre serviços da empresa através de voz.

**Empresa:** Mozaitelecomunicação (exemplo)
**Idioma:** Português de Moçambique

---

## ✨ Funcionalidades

✅ **Sem Autenticação** - Qualquer usuário pode fazer perguntas imediatamente
✅ **Memória de Conversa** - Lembra os últimos 10 intercâmbios para contexto
✅ **LangChain RAG** - Sistema aprimorado com melhor precisão
✅ **Base de Conhecimento** - Respostas apenas da documentação PDF
✅ **Filtro de Profanidade** - Bloqueia linguagem inapropriada
✅ **Interrupção** - Pode parar o AI e fazer nova pergunta
✅ **Voz Bidirecional** - Entrada por voz (Whisper) e saída por voz (TTS)
✅ **WebSocket Real-time** - Comunicação instantânea

---

## 🏗️ Arquitetura

```
User (Voice)
    ↓
Whisper (STT)
    ↓
LangChain RAG + Memory
    ↓
FAISS Vector Search → PDF Knowledge Base
    ↓
GPT-4o-mini (Answer)
    ↓
TTS (Voice)
    ↓
User (Voice)
```

**Tech Stack:**
- **Backend:** FastAPI + WebSocket
- **RAG:** LangChain + FAISS
- **AI:** OpenAI (Whisper, GPT-4o-mini, TTS-1)
- **Frontend:** Vanilla JS + HTML/CSS
- **Vector DB:** FAISS (text-embedding-3-large, 3072 dims)

---

## 📋 Requisitos

- Python 3.10+
- Navegador moderno (Chrome, Firefox, Safari 14+)
- Microfone e alto-falantes
- OpenAI API Key

---

## 🚀 Instalação

### 1. Clonar Repositório

```bash
git clone git@github.com:Paulino-Cristovao/voiceRAG.git
cd voiceRAG
```

### 2. Criar Ambiente Virtual

```bash
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate
```

### 3. Instalar Dependências

```bash
pip install -r requirements.txt
```

### 4. Configurar API Key

```bash
cp .env.example .env
# Edit .env and add your OpenAI API key:
# OPENAI_API_KEY=sk-your-key-here
```

### 5. Verificar Dados

```bash
# Check knowledge base is indexed
ls data/index.faiss data/metadata.pkl

# If missing, rebuild index:
python ingest_pdfs.py
```

### 6. Iniciar Servidor

```bash
python app.py
# or
./start.sh
```

### 7. Abrir no Navegador

```
http://localhost:8000
```

**Permitir acesso ao microfone quando solicitado!**

---

## 📁 Estrutura do Projeto

```
voiceRAG/
├── app.py                    # Main application (LangChain RAG)
├── ingest_pdfs.py           # Build FAISS index from PDFs
├── requirements.txt         # Python dependencies
├── start.sh                 # Startup script
├── .env.example             # Environment template
├── .gitignore              # Git exclusions
│
├── static/                  # Frontend
│   ├── index.html          # Main interface
│   ├── diagnostic.html     # Browser/mic testing
│   └── favicon.svg         # Icon
│
├── data/                    # Vector database (generated)
│   ├── index.faiss         # FAISS vector index
│   └── metadata.pkl        # Chunk metadata
│
└── pdfs/                    # Knowledge base source
    ├── sample_support.txt  # Main documentation
    └── *.pdf              # Additional PDFs
```

**Note:** The `data/` folder is generated by `ingest_pdfs.py` from PDFs.

---

## 🎯 Como Usar

### Primeira Vez

1. Abra `http://localhost:8000`
2. Clique no círculo do microfone (permite acesso)
3. Sistema saúda: "Olá! Bem-vindo à Mozaitelecomunicação..."
4. Clique no microfone e faça sua pergunta (5 segundos)
5. AI responde com voz

### Conversação

```
Você: "Quanto custa o plano Premium 5G?"
AI: "O plano Premium 5G custa 1.500 MZN/mês..."

Você: "E qual você recomenda para um estudante?"
AI: "Para estudante, recomendo o Plano Básico 4G, 500 MZN/mês..." ✅
     ^ Lembra o contexto da pergunta anterior!
```

### Interromper

- Enquanto AI fala, clique no botão **"🛑 Interromper"**
- Áudio para imediatamente
- Pode fazer nova pergunta

---

## 🔧 Configuração Avançada

### Variáveis de Ambiente (.env)

```bash
OPENAI_API_KEY=sk-your-key-here
EMBEDDING_MODEL=text-embedding-3-large  # or text-embedding-3-small
CHAT_MODEL=gpt-4o-mini                  # or gpt-4o
TOP_K=5                                  # Number of chunks to retrieve
```

### Adicionar Documentação

```bash
# 1. Adicione PDFs ou TXT em pdfs/
cp your_docs.pdf pdfs/

# 2. Reconstrua o índice FAISS
python ingest_pdfs.py

# 3. Reinicie o servidor
python app.py
```

---

## 🧪 Testes

### Teste Rápido (2 minutos)

```
1. "Quais são os vossos serviços?"
   → Deve listar serviços da empresa

2. "Quanto custa o Premium 5G?"
   → "1.500 MZN/mês"

3. "E qual recomenda para estudante?"
   → Deve recomendar plano (lembra contexto!) ✅

4. "Qual é o email de apoio?"
   → "apoio@mozaitelecomunicacao.co.mz"

5. "Qual é o tempo hoje?"
   → Deve rejeitar e redirecionar para suporte
```

### Diagnóstico

Abra `http://localhost:8000/diagnostic` para testar:
- Suporte do navegador
- Acesso ao microfone
- WebSocket
- Reprodução de áudio

---

## 🐛 Troubleshooting

### Microfone não funciona

**Problema:** "Seu navegador não suporta gravação de áudio"

**Soluções:**
1. Use `http://localhost:8000` (não IP address)
2. Chrome: 🔒 → Microfone → Permitir
3. Safari: Preferências → Sites → Microfone → Permitir
4. Teste em outro navegador (Chrome 60+, Firefox 55+, Safari 14+)

### Servidor não inicia

**Problema:** "Address already in use"

```bash
# Matar processo na porta 8000
lsof -ti:8000 | xargs kill -9

# Reiniciar
python app.py
```

### Respostas incorretas

**Problema:** AI não encontra informação que está no PDF

```bash
# Reconstruir índice FAISS
python ingest_pdfs.py

# Verificar chunks criados
# Should see: "Created X chunks"

# Reiniciar
python app.py
```

### Sem memória de conversa

**Problema:** AI não lembra pergunta anterior

**Verificação:**
1. Logs devem mostrar: `💬 History: X messages`
2. Se mostrar `💬 History: 0 messages` sempre, há problema
3. Verifique está usando a versão LangChain:
   ```bash
   head -5 app.py
   # Deve conter: "from langchain_openai import"
   ```

---

## 💰 Custos (OpenAI API)

| Operação | Custo por Query |
|----------|----------------|
| Embedding (search) | ~$0.00013 |
| GPT-4o-mini (answer) | ~$0.0001-0.0002 |
| Whisper (STT) | ~$0.0006 |
| TTS-1 (voice) | ~$0.00015 |
| **Total** | **~$0.001 per query** |

**Mensal (1000 queries):** ~$1.00/mês

---

## 📊 Performance

| Métrica | Valor |
|---------|-------|
| Tempo de resposta | 2-4 segundos |
| Dimensões vetoriais | 3072 (text-embedding-3-large) |
| Memória de conversa | 10 últimas trocas |
| Precisão (testes) | 100% (4/4 queries) |
| Chunks na base | Variável (depende dos PDFs) |

---

## 🔐 Segurança

- ✅ Filtro de profanidade (português + inglês)
- ✅ Validação de entrada
- ✅ Respostas apenas da base de conhecimento
- ✅ Redirecionamento para suporte em casos sensíveis
- ⚠️ **Não usar .env em produção** (usar secrets manager)
- ⚠️ **Adicionar rate limiting** para produção

---

## 🚀 Deploy em Produção

### Recomendações:

1. **HTTPS obrigatório** (microfone requer conexão segura)
2. **Rate limiting** (prevenir abuso)
3. **Logging estruturado** (monitoring)
4. **Secrets management** (não usar .env)
5. **Load balancer** (se múltiplas instâncias)

### Exemplo Docker:

```dockerfile
FROM python:3.10-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt
COPY . .
CMD ["python", "app.py"]
```

---

## 📚 Documentação Adicional

- **LANGCHAIN_UPGRADE.md** - Detalhes da integração LangChain + resultados de testes
- **.env.example** - Exemplo de configuração
- **static/diagnostic.html** - Página de diagnóstico

---

## 🤝 Contribuir

1. Fork o repositório
2. Crie branch: `git checkout -b feature/nova-funcionalidade`
3. Commit: `git commit -m 'Add nova funcionalidade'`
4. Push: `git push origin feature/nova-funcionalidade`
5. Abra Pull Request

---

## 📄 Licença

MIT License - Veja LICENSE file para detalhes

---

## 🙏 Créditos

- **OpenAI** - Whisper, GPT-4o-mini, TTS, Embeddings
- **LangChain** - RAG framework
- **FAISS** - Vector search (Facebook AI)
- **FastAPI** - Web framework

---

## 📞 Suporte

**GitHub Issues:** https://github.com/Paulino-Cristovao/voiceRAG/issues

**Email:** (adicione seu email aqui)

---

**Desenvolvido com Claude Code** 🤖
